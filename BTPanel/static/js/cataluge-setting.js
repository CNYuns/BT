import{B as a}from"./index119.js?v=1764728423";import{u as e,E as t,M as l,b6 as s,p as i,Q as n,aH as o,H as d,n as r,aK as u,y as c,e as m,k as p,j as f,_ as g}from"./utils-lib.js?v=1764728423";import{r as h,o as y,s as _,n as v,e as w,c as V,v as b,I as x,J as C,z as P,x as k,y as I,A as U,C as j,D as q,F,b1 as T,R as L,K as E,O as A,G as D,H as N,an as R,ap as H,b2 as S,ad as O,ab as z,am as G}from"./base-lib.js?v=1764728423";import{_ as K}from"./index107.js?v=1764728423";import{f as M,k as B,p as J,l as Q}from"./validator.js?v=1764728423";import{o as W}from"./useController6.js?v=1764728423";import{setHasPwd as X,closeHasPwd as Y,setPath as Z,setSiteRunPath as $,getSitesFtp as aa,setSitesFtp as ea,delSiteRsync as ta,removeSendTask as la,delGitTask as sa,getGitTask as ia,addGitTask as na,runSiteTask as oa,getFileBody as da,setDirUserINI as ra,writeAccessLog as ua,getCatalogueKey as ca,getDirUserINI as ma,getBtSyncStatus as pa}from"./site.js?v=1764728423";import{u as fa}from"./useStore4.js?v=1764728423";import"./ace.js?v=1764728423";import"./__commonjsHelpers__.js?v=1764728423";import"./index110.js?v=1764728423";import"./column.js?v=1764728423";const{payment:ga}=e(),{siteInfo:ha}=fa(),{authType:ya}=ga.value,_a=h(!1),va=h(),wa=h(),Va=y({path:"",runPath:"",dirs:[],userini:!1,sync_git:!1,logs:!1,pass:!1}),ba=h(!1),xa=y({ftp_status:!1,ftp_name:"",ftp_pwd:""}),Ca=h(!1),Pa=h(""),ka=h([]),Ia=h(!1),Ua=y({git_addr:"",branch:"",cycle:1}),ja=h(""),qa=h(!1),Fa=h(!1),Ta={git_addr:[{required:!0,message:"请输入git地址",trigger:"blur"}]};h({mode:"ace/mode/nginx",theme:t.value?"ace/theme/clouds_midnight":"ace/theme/monokai",wrap:!0,showInvisibles:!1,showFoldWidgets:!1,useSoftTabs:!0,tabSize:2,showPrintMargin:!1,readOnly:!0,fontSize:"12px"});const La=y({status:!1,username:"",password:"",rePass:""}),Ea={username:[{required:!0,message:"账号不能为空",trigger:["blur"]}],password:[{required:!0,message:"密码不能为空",trigger:["blur"]}],rePass:[{required:!0,message:"重复密码不能为空",trigger:["blur"]},{validator:(a,e,t)=>{e!==La.password?t(new Error("两次输入密码不一致")):t()},trigger:["blur","change"]}]},Aa=async()=>{va.value.validate(async a=>{if(a){let a=l.load("正在设置,请稍后...");try{const a=await X({id:ha.value.id,username:La.username,password:La.password});l.request(a)}catch(e){}finally{a.close()}}})},Da=async a=>{let e;try{if(!a){e=l.load("正在关闭密码访问,请稍后...");const a=await Y({id:ha.value.id});e.close(),l.request(a)}}catch(t){}finally{null==e||e.close()}},Na=()=>{M({type:"dir",path:Va.path,change:a=>{Va.path=a}})},Ra=async()=>{try{const a=await ma({path:Va.path,id:ha.value.id});Va.dirs=a.data.runPath.dirs,Va.runPath=a.data.runPath.runPath,Va.sync_git=a.data.sync_git,Va.logs=a.data.logs,Va.userini=a.data.userini,La.status=a.data.pass}catch(a){}},Ha=async()=>{let a=l.load("正在保存中...");try{const a=await Z({path:Va.path,id:ha.value.id});l.request(a),a.status&&(ha.value.path=Va.path),Ra()}catch(e){}finally{a.close()}},Sa=async()=>{let a=l.load("正在设置,请稍后...");try{const a=await $({runPath:Va.runPath,id:ha.value.id});l.request(a)}catch(e){}finally{a.close()}},Oa=async()=>{var a,e,t;try{const l=await aa({site_id:ha.value.id});(null==(a=l.data.info)?void 0:a.id)?(xa.ftp_status=!0,xa.ftp_id=null==(e=l.data.info)?void 0:e.id,xa.ftp_name=null==(t=l.data.info)?void 0:t.name,xa.ftp_pwd=l.data.info.password):(xa.ftp_status=!1,xa.ftp_name="",xa.ftp_pwd="",xa.ftp_id="")}catch(l){}},za=async(a,e)=>{if(e){let a=l.load("正在处理中,请稍后...");try{if(!xa.ftp_id)return void za(!0,!1);let a={site_id:ha.value.id,...xa,siteName:ha.value.name};delete a.ftp_status;const e=await ea(a);if(l.request(e),Oa(),!e.data.status)return!1;ba.value=!1}catch(t){}finally{a.close()}}else{a&&(xa.ftp_name=xa.ftp_name||s(12),xa.ftp_pwd=xa.ftp_pwd||s(12));let e={site_id:ha.value.id,...xa,siteName:ha.value.name};e.ftp_id||delete e.ftp_id,xa.ftp_status=!a,await i({title:"FTP状态",content:a?"创建FTP将会同步到FTP界面，是否继续操作？":"关闭FTP后，将会删除当前网站的FTP账号，是否继续操作？",icon:"warning-filled"}),await n({loading:"正在处理中,请稍后...",request:ea(e),message:!0}),Oa()}},Ga=async()=>{var a,e,t,l,s,i;try{const n=await pa({path:Va.path});Ca.value=n.data.have_sync,Ca.value&&(ka.value=Array.isArray(null==(a=n.data)?void 0:a.data)?null==(e=n.data)?void 0:e.data:[],(null==(l=null==(t=n.data)?void 0:t.data)?void 0:l.name)&&(Pa.value=null==(i=null==(s=n.data)?void 0:s.data)?void 0:i.name))}catch(n){}},Ka=async a=>{try{if(Ca.value=a,a){const{data:a}=await o({sName:"rsync"});if(a.setup&&a.endtime>=0)if(parseFloat(a.version)>=parseFloat("3.9.3")){const{default:a}=await d(()=>import("./validator.js?v=1764728423").then(a=>a.dk),__vite__mapDeps([]),import.meta.url),e=a(),{compData:t,isSuccess:l}=_(e);t.value={row:{path:ha.value.path,type:"site",refreshEvent:Ga}},r({isAsync:!0,title:"【".concat(ha.value.name,"】设置数据同步"),area:56,component:()=>d(()=>import("./index159.js?v=1764728423"),__vite__mapDeps([]),import.meta.url),onCancel:()=>{v(()=>{l.value||(Ca.value=!1)})}})}else await i({title:"更新提示",content:"当前版本过低，无法使用此功能，是否继续更新？",icon:"warning-filled"}),await Ma(a);else a.endtime>=0?(await i({title:"安装提示",content:"检测到【".concat(a.title,"】未安装，是否立即安装开启使用？"),icon:"warning-filled"}),B({name:a.name,type:"i",pluginInfo:a})):J({sourceId:120}),v(()=>{Ca.value=!1})}else{if(await i({title:"删除同步任务",content:"即将删除该同步任务，是否继续操作？",icon:"warning-filled"}),ka.value.length){const a=l.load("正在删除同步任务，请稍后..."),e=ka.value.map(async a=>{if("modules"===a.type){return{...(await ta({mName:a.data.name})).data,title:"接收任务",name:a.data.name}}return{...(await la({send_id:a.data.id})).data,title:"发送任务",name:a.data.name}}),t=await Promise.all(e);a.close(),t.length>1?W({title:"删除同步任务",autoTitle:"删除同步任务完成",resultData:t,resultColumn:[{label:"任务名称",prop:"name"},{label:"任务类型",prop:"title"},{label:"操作结果",prop:"msg",align:"rigth",render:a=>w("span",{class:a.status?"text-primary":"text-danger"},[a.msg])}]}):l.request(t[0])}else await n({loading:"正在删除同步任务，请稍后...",request:ta({mName:Pa.value}),message:!0});Ga()}}catch(e){Ca.value=!a}},Ma=async a=>{},Ba=async()=>{try{const{data:a}=await o({sName:"rsync"});await Q({name:"rsync",softData:a})}catch(a){}},Ja=async a=>{if("ltd"!==ya)return J({sourceId:310,disablePro:!0});if(a)Va.sync_git=!1,await Wa();else{Va.sync_git=!0,await i({title:"关闭git同步",content:"关闭后将不在同步git文件到网站目录，是否继续操作？",icon:"warning-filled"});const a=await n({loading:"正在关闭，请稍后...",request:sa({site_id:ha.value.id}),message:!0});a.status&&(Va.sync_git=!a.status)}},Qa=async()=>{if("ltd"!==ya)return J({sourceId:310,disablePro:!0});await Wa(),Ia.value=!0},Wa=async()=>{var a;try{const{data:e}=await ia({site_id:ha.value.id});(null==(a=e.msg)?void 0:a.git_addr)?(Ua.git_addr=e.msg.git_addr,Ua.branch=e.msg.branch,Ua.cycle=e.msg.cycle):(Ua.git_addr="",Ua.branch="",Ua.cycle=1,Ia.value=!0)}catch(e){}},Xa=async()=>{await wa.value.validate(),await i({title:"git同步覆盖提示",content:"从git同步文件到网站目录将覆盖网站目录的文件，是否继续操作？",icon:"warning-filled"});(await n({loading:"正在设置，请稍后...",request:na({site_id:ha.value.id,...Ua}),message:!0})).status&&(Ia.value=!1,Ra())},Ya=async()=>{if("ltd"!==ya)return J({sourceId:310,disablePro:!0});n({request:oa({site_id:ha.value.id}),message:!0})},Za=async()=>{await $a(),Fa.value=!0},$a=async()=>{qa.value=!0;try{const a=await da({path:"/www/wwwlogs/syncsite/"+ha.value.id+".log"});ja.value=a.data.data||"暂无日志数据"}catch(a){u(a)}finally{qa.value=!1}},ae=async()=>{(await n({loading:"正在设置防跨站，请稍后...",request:ra({path:Va.path}),message:!0})).status&&Ra()},ee=async()=>{(await n({loading:"正在设置写访问日志，请稍后...",request:ua({id:ha.value.id}),message:!0})).status&&Ra()},te=async()=>{_a.value=!0;try{await(async()=>{try{const a=await ca({table:"sites",key:"path",id:ha.value.id});Va.path=a.data}catch(a){}})(),await Ra(),await Oa(),await Ga()}catch(a){}finally{_a.value=!1}},le={class:""},se={class:"formItem"},ie={class:"formItem"},ne={class:"formItem"},oe={class:"formItem"},de={class:"formItem flex flex-col !items-start"},re={class:"flex justify-center items-center"},ue={class:"formItem"},ce={class:"formItem"},me={class:"flex items-center"},pe={class:"p-[20px]"},fe={class:"p-[20px]"},ge={class:"p-[20px]"},he={class:"flex items-center justify-between"},ye=g(V({__name:"cataluge-setting",setup(t,{expose:l}){const{enterpriseRec:s}=e();return b(te),l({init:te}),(e,t)=>{const l=K,i=N,n=G,o=R,d=H,r=m,u=S,g=p,h=O,y=z,_=f,v=a,V=x("bt-loading");return C((k(),I("div",le,[U("div",se,[t[26]||(t[26]=U("span",{class:"formLabel"},"网站目录",-1)),w(l,{class:"mr-[12px]",modelValue:P(Va).path,"onUpdate:modelValue":t[0]||(t[0]=a=>P(Va).path=a),icon:"el-folder-opened",onIconClick:P(Na),width:"32rem"},null,8,["modelValue","onIconClick"]),w(i,{type:"primary",onClick:P(Ha)},{default:j(()=>[...t[25]||(t[25]=[q("保存",-1)])]),_:1},8,["onClick"])]),t[51]||(t[51]=U("span",{class:"formTips"},"当前网站的部署目录，可以选择其他目录",-1)),U("div",ie,[t[28]||(t[28]=U("span",{class:"formLabel"},"运行目录",-1)),w(o,{class:"mr-[12px] !w-[32rem]",modelValue:P(Va).runPath,"onUpdate:modelValue":t[1]||(t[1]=a=>P(Va).runPath=a)},{default:j(()=>[(k(!0),I(F,null,T(P(Va).dirs,a=>(k(),A(n,{key:a,label:a,value:a},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),w(i,{type:"primary",onClick:P(Sa)},{default:j(()=>[...t[27]||(t[27]=[q("保存",-1)])]),_:1},8,["onClick"])]),t[52]||(t[52]=U("span",{class:"formTips"},"部分程序需要指定二级目录作为运行目录，如ThinkPHP5,Laravel",-1)),U("div",ne,[t[30]||(t[30]=U("span",{class:"formLabel"},"添加FTP",-1)),w(d,{class:"mr-[12px]",modelValue:P(xa).ftp_status,"onUpdate:modelValue":t[2]||(t[2]=a=>P(xa).ftp_status=a),onChange:P(za)},null,8,["modelValue","onChange"]),t[31]||(t[31]=U("span",{class:"text-tertiary"},"为当前目录添加一个FTP账号，以支持访问",-1)),w(r,{onClick:t[3]||(t[3]=a=>ba.value=!0)},{default:j(()=>[...t[29]||(t[29]=[q("点击配置>>",-1)])]),_:1})]),U("div",oe,[t[33]||(t[33]=U("span",{class:"formLabel"},"文件同步",-1)),w(d,{class:"mr-[12px]",modelValue:P(Ca),"onUpdate:modelValue":t[4]||(t[4]=a=>L(Ca)?Ca.value=a:null),onChange:P(Ka)},null,8,["modelValue","onChange"]),t[34]||(t[34]=U("i",{class:"svgtofont-icon-ltd text-extraLarge text-ltd mr-4px"},null,-1)),t[35]||(t[35]=U("span",{class:"text-tertiary"},"可以同步网站文件至其他服务节点",-1)),w(r,{onClick:P(Ba)},{default:j(()=>[...t[32]||(t[32]=[q("点击配置>>",-1)])]),_:1},8,["onClick"])]),C(U("div",de,[U("div",re,[t[39]||(t[39]=U("span",{class:"formLabel"},"git同步",-1)),w(d,{class:"mr-[12px]",modelValue:P(Va).sync_git,"onUpdate:modelValue":t[5]||(t[5]=a=>P(Va).sync_git=a),onChange:P(Ja)},null,8,["modelValue","onChange"]),t[40]||(t[40]=U("i",{class:"svgtofont-icon-ltd text-extraLarge text-ltd mr-4px"},null,-1)),t[41]||(t[41]=U("span",{class:"text-tertiary"},"可以从git中下载文件到网站目录中",-1)),w(r,{onClick:P(Qa)},{default:j(()=>[...t[36]||(t[36]=[q("点击配置>>",-1)])]),_:1},8,["onClick"]),w(u,{direction:"vertical"}),w(r,{onClick:P(Za)},{default:j(()=>[...t[37]||(t[37]=[q("查看日志",-1)])]),_:1},8,["onClick"]),w(u,{direction:"vertical"}),w(r,{onClick:P(Ya)},{default:j(()=>[...t[38]||(t[38]=[q("立即同步",-1)])]),_:1},8,["onClick"])]),t[42]||(t[42]=U("span",{class:"pl-[145px] text-red"},"此功能存在设计缺陷，将于11.4.0版本下架",-1))],512),[[E,P(s)]]),w(u),U("div",ue,[t[43]||(t[43]=U("span",{class:"formLabel"},"防跨站攻击",-1)),w(d,{class:"mr-[12px]",modelValue:P(Va).userini,"onUpdate:modelValue":t[6]||(t[6]=a=>P(Va).userini=a),onChange:P(ae)},null,8,["modelValue","onChange"]),t[44]||(t[44]=U("span",{class:"text-tertiary"},"防跨站攻击(open_basedir)，防止黑客通过其他网站目录进行入侵攻击",-1))]),U("div",ce,[t[45]||(t[45]=U("span",{class:"formLabel"},"写访问日志",-1)),w(d,{class:"mr-[12px]",modelValue:P(Va).logs,"onUpdate:modelValue":t[7]||(t[7]=a=>P(Va).logs=a),onChange:P(ee)},null,8,["modelValue","onChange"]),t[46]||(t[46]=U("span",{class:"text-tertiary"},"允许当前日志增加访问日志",-1))]),w(u),U("div",me,[t[47]||(t[47]=U("span",{class:"mr-[20px] w-[7rem] text-right"},"密码访问",-1)),w(d,{modelValue:P(La).status,"onUpdate:modelValue":t[8]||(t[8]=a=>P(La).status=a),onChange:P(Da)},null,8,["modelValue","onChange"])]),P(La).status?(k(),A(y,{key:0,model:P(La),ref_key:"passVisitFormRef",ref:va,rules:P(Ea),class:"mt-[20px]","label-width":"70px","label-position":"right"},{default:j(()=>[w(h,{label:"账号",prop:"username"},{default:j(()=>[w(g,{width:"20rem",modelValue:P(La).username,"onUpdate:modelValue":t[9]||(t[9]=a=>P(La).username=a),placeholder:"不修改请留空"},null,8,["modelValue"])]),_:1}),w(h,{label:"访问密码",prop:"password"},{default:j(()=>[w(g,{width:"20rem",modelValue:P(La).password,"onUpdate:modelValue":t[10]||(t[10]=a=>P(La).password=a),type:"password",placeholder:"不修改请留空"},null,8,["modelValue"])]),_:1}),w(h,{label:"重复密码",prop:"rePass"},{default:j(()=>[w(g,{width:"20rem",modelValue:P(La).rePass,"onUpdate:modelValue":t[11]||(t[11]=a=>P(La).rePass=a),type:"password",placeholder:"不修改请留空"},null,8,["modelValue"])]),_:1}),w(h,{label:" "},{default:j(()=>[w(i,{type:"primary",onClick:P(Aa)},{default:j(()=>[...t[48]||(t[48]=[q("保存",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["model","rules"])):D("",!0),w(_,{title:"FTP配置",modelValue:P(ba),"onUpdate:modelValue":t[16]||(t[16]=a=>L(ba)?ba.value=a:null),area:42,showFooter:"",onConfirm:t[17]||(t[17]=a=>P(za)(!1,!0)),onClose:t[18]||(t[18]=a=>P(Oa)())},{default:j(()=>[U("div",pe,[w(y,{"label-position":"right",model:P(xa)},{default:j(()=>[w(h,{label:"用户名"},{default:j(()=>[w(g,{modelValue:P(xa).ftp_name,"onUpdate:modelValue":t[12]||(t[12]=a=>P(xa).ftp_name=a),placeholder:"请输入ftp用户名",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),w(h,{label:"密码"},{default:j(()=>[w(l,{modelValue:P(xa).ftp_pwd,"onUpdate:modelValue":t[13]||(t[13]=a=>P(xa).ftp_pwd=a),icon:"el-refresh",onIconClick:t[14]||(t[14]=()=>P(xa).ftp_pwd=P(c)(16)),width:"32rem"},null,8,["modelValue"])]),_:1}),w(h,{label:"根目录"},{default:j(()=>[w(g,{modelValue:P(Va).path,"onUpdate:modelValue":t[15]||(t[15]=a=>P(Va).path=a),disabled:"",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])]),_:1},8,["modelValue"]),w(_,{title:"配置GIT同步",modelValue:P(Ia),"onUpdate:modelValue":t[22]||(t[22]=a=>L(Ia)?Ia.value=a:null),area:42,showFooter:"",onConfirm:P(Xa)},{default:j(()=>[U("div",fe,[w(y,{"label-position":"right",ref_key:"gitFormRef",ref:wa,model:P(Ua),rules:P(Ta)},{default:j(()=>[w(h,{label:"git地址",prop:"git_addr"},{default:j(()=>[w(g,{modelValue:P(Ua).git_addr,"onUpdate:modelValue":t[19]||(t[19]=a=>P(Ua).git_addr=a),placeholder:"请输入git地址",width:"24rem"},null,8,["modelValue"])]),_:1}),w(h,{label:"分支"},{default:j(()=>[w(g,{modelValue:P(Ua).branch,"onUpdate:modelValue":t[20]||(t[20]=a=>P(Ua).branch=a),placeholder:"请输入git分支,为空默认主分支",width:"24rem"},null,8,["modelValue"])]),_:1}),w(h,{label:"同步周期"},{default:j(()=>[w(g,{modelValue:P(Ua).cycle,"onUpdate:modelValue":t[21]||(t[21]=a=>P(Ua).cycle=a),"text-type":"天",type:"number",min:1,width:"24rem"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])])]),_:1},8,["modelValue","onConfirm"]),w(_,{title:"Git日志",modelValue:P(Fa),"onUpdate:modelValue":t[24]||(t[24]=a=>L(Fa)?Fa.value=a:null),area:70},{default:j(()=>[U("div",ge,[U("div",he,[w(i,{type:"primary",onClick:P($a)},{default:j(()=>[...t[49]||(t[49]=[q("刷新",-1)])]),_:1},8,["onClick"]),t[50]||(t[50]=U("span",{class:"text-tertiary mt-[8px]"},"提示：支持Ctrl + F，快捷搜索日志内容",-1))]),C(w(v,{class:"!h-[54rem] !w-full my-[12px]",modelValue:P(ja),"onUpdate:modelValue":t[23]||(t[23]=a=>L(ja)?ja.value=a:null),config:e.config},null,8,["modelValue","config"]),[[V,P(qa)]])])]),_:1},8,["modelValue"])])),[[V,P(_a)]])}}}),[["__scopeId","data-v-2d6feac2"]]);export{ye as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
