import{L as a,M as e,Q as s,B as l,p as t,ax as o,d as r,N as i,k as c,_ as n}from"./utils-lib.js?v=1764656280";import{_ as u}from"./index111.js?v=1764656280";import{c as p,r as d,g as m,v as _,I as b,J as h,z as k,x as v,y as g,e as y,C as f,O as x,A as w,G as j,B as C,n as q,ad as V}from"./base-lib.js?v=1764656280";import{g as W}from"./form-item.js?v=1764656280";import{updateGitmanagerSite as A,getBranchList as U,refreshWebhook as B,getGitmanager as I}from"./site.js?v=1764656280";import{u as L}from"./useStore4.js?v=1764656280";import{w as O,x as S}from"./useController5.js?v=1764656280";import"./__commonjsHelpers__.js?v=1764656280";import"./column.js?v=1764656280";import"./useController6.js?v=1764656280";import"./validator.js?v=1764656280";import"./index108.js?v=1764656280";import"./useMethod5.js?v=1764656280";const H={class:"overflow-auto max-h-63rem"},M={class:"flex flex-col pt-5px w-40rem leading-22px"},R={class:"flex flex-col pt-5px w-40rem leading-22px"},z={class:"flex items-center custom-refresh-select"},F={class:"el-input-group__append !h-3rem !flex items-center"},G={class:"flex flex-col gap-8px w-40rem leading-22px"},J=n(p({__name:"index",setup(n,{expose:p}){const{siteInfo:J}=L(),K=d(!1),N=d([]),Q=d(!1),D=async(a=!1)=>{try{if(!Y.value.repo)return void e.error("请先填写仓库地址");s({request:U({repo:Y.value.repo,force:a?1:0}),data:{data:[Array,a=>a.map(a=>({label:a,value:a}))]},success:s=>{N.value=Array.isArray(s.data)?s.data:[],a&&e.success("分支列表已刷新")}})}catch(l){}},E=async()=>{try{const a=await S();Y.value.ssh_key=a.ssh_key.msg,Q.value=a.webhook_install}catch(a){}},P=async()=>{await t({title:"重置令牌",content:"重置后旧链接将失效，Webhook 日志将被清空，且需要重新选择脚本。是否继续？ URL将失效。"}),s({loading:"正在重置Webhook令牌，请稍后...",request:B({git_manager_id:J.value.git_manager.id}),success:a=>{a.data.data.webhook_url&&(Y.value.webhook_url=a.data.data.webhook_url),e.request({status:a.data.status,msg:a.data.status?"重置成功":"重置失败"})}})},{BtForm:T,submit:X,param:Y}=a({data:()=>({}),options:()=>m(()=>[{type:"slots",key:"gitconf",rules:{branch:[{required:!0,message:"请选择分支",trigger:["change","blur"]}]}},W("保存",{attrs:{class:"!ml-[12rem]",type:"primary",onClick:X}})]),submit:async(a,l,t)=>{if(await l(),!Q.value)return void e.error("Webhook 未安装，无法保存配置");const{branch:o,deploy_script:r}=a.value;return(await s({loading:"正在设置仓库配置，请稍后...",request:A({git_manager_id:J.value.git_manager.id,branch:o,deploy_script:r}),message:!0,success:a=>{}})).status}}),Z=async()=>{q(async()=>{await(async()=>{try{await s({loading:K,request:I({git_manager_id:J.value.git_manager.id}),data:{data:Object},success:a=>{Object.assign(Y.value,{repo:a.repo_url,branch:a.branch,deploy_script:a.deploy_script,webhook_url:a.webhook_url})}})}catch(a){}})(),D(),E()})};return _(Z),p({init:Z}),(a,e)=>{const s=V,t=u,n=o,p=r,d=i,m=c,_=b("bt-loading");return h((v(),g("div",H,[y(k(T),{"label-width":"10rem"},{gitconf:f(()=>[k(Q)?j("",!0):(v(),x(s,{key:0,label:"Webhook"},{default:f(()=>[w("span",{class:"bt-danger text-small",onClick:e[0]||(e[0]=a=>(async a=>O(a,E))("webhook"))}," 未安装Webhook，点击安装 ")]),_:1})),y(s,{label:"SSH Key",prop:"ssh_key",class:"!mb-1rem"},{default:f(()=>[w("div",M,[w("div",{onClick:e[1]||(e[1]=a=>k(l)({value:k(Y).ssh_key}))},C(k(Y).ssh_key),1),w("div",null,[w("span",{class:"bt-link",onClick:e[2]||(e[2]=a=>k(l)({value:k(Y).ssh_key}))},"复制")])])]),_:1}),y(s,{label:"仓库",prop:"repo",class:"!mb-1rem"},{default:f(()=>[w("div",{onClick:e[3]||(e[3]=a=>k(l)({value:k(Y).repo}))},C(k(Y).repo),1)]),_:1}),y(s,{label:"Webhook URL",class:"!mb-1rem"},{default:f(()=>[w("div",R,[w("div",{onClick:e[4]||(e[4]=a=>k(l)({value:k(Y).webhook_url}))},C(k(Y).webhook_url),1),w("div",null,[w("span",{class:"bt-link",onClick:e[5]||(e[5]=a=>k(l)({value:k(Y).webhook_url}))},"复制"),y(t),w("span",{class:"bt-link",onClick:P},"重置令牌")])])]),_:1}),y(s,{label:"分支",prop:"branch"},{default:f(()=>[w("div",z,[y(n,{modelValue:k(Y).branch,"onUpdate:modelValue":e[6]||(e[6]=a=>k(Y).branch=a),options:k(N),class:"!w-[30rem]",placeholder:"请选择分支"},null,8,["modelValue","options"]),w("div",F,[y(d,{title:"刷新分支",class:"!flex",onClick:e[7]||(e[7]=a=>D(!0))},{default:f(()=>[y(p,{icon:"el-refresh",class:"!text-base"})]),_:1})])])]),_:1}),y(s,{label:"部署脚本",prop:"deploy_script"},{default:f(()=>[w("div",G,[y(m,{type:"textarea",rows:10,class:"!w-40rem",placeholder:"请输入部署脚本",modelValue:k(Y).deploy_script,"onUpdate:modelValue":e[8]||(e[8]=a=>k(Y).deploy_script=a)},null,8,["modelValue"]),e[9]||(e[9]=w("div",{class:"text-small"},"* 脚本将会在获取最新代码（git pull）后执行",-1))])]),_:1})]),_:1})])),[[_,k(K)]])}}}),[["__scopeId","data-v-31894326"]]);export{J as default};
